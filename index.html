<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Video + Suara HP Jadul</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #111; color: #eee; padding: 40px; }
    input, select, button { margin: 10px; padding: 10px; font-size: 16px; border-radius: 8px; border: none; }
    button { background: #0077ff; color: white; cursor: pointer; }
    button:disabled { background: gray; cursor: not-allowed; }
  </style>
</head>
<body>
  <h1>🎥 Konversi Video + Suara Jadi Efek Jadul</h1>
  <input type="file" id="videoInput" accept="video/*"><br>
  <select id="preset">
    <option value="nokia">📱 Nokia</option>
    <option value="radio">📻 Radio</option>
    <option value="broken">☎️ Telepon Rusak</option>
    <option value="proklamasi">🎙️ Mic Proklamasi</option>
  </select><br>
  <button id="processBtn" disabled>🔊 Proses Video</button>
  <button id="downloadBtn" disabled>⬇️ Download Video</button><br>
  <video id="videoPlayer" controls style="max-width:80%;"></video>

  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.2/dist/ffmpeg.min.js"></script>
  <script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: true });
    let processedBlob = null;

    document.getElementById("videoInput").addEventListener("change", (e) => {
      if (e.target.files.length > 0) {
        document.getElementById("processBtn").disabled = false;
      }
    });

    document.getElementById("processBtn").addEventListener("click", async () => {
      const file = document.getElementById("videoInput").files[0];
      const preset = document.getElementById("preset").value;

      if (!ffmpeg.isLoaded()) {
        await ffmpeg.load();
      }

      ffmpeg.FS("writeFile", "input.mp4", await fetchFile(file));

      // Tentukan filter sesuai preset
      let filter = "";
      if (preset === "nokia") {
        filter = "lowpass=f=3000,aresample=8000";
      } else if (preset === "radio") {
        filter = "bandpass=f=2000:width_type=h:width=3500,aresample=8000";
      } else if (preset === "broken") {
        filter = "lowpass=f=2000,acrusher=bits=6:mix=0.5";
      } else if (preset === "proklamasi") {
        // Mic tua: bandpass sempit + distorsi + noise tipis
        filter = "highpass=f=300,lowpass=f=3000,acrusher=bits=7:mix=0.3,anlmdn=s=0.002";
      }

      await ffmpeg.run(
        "-i", "input.mp4",
        "-vf", "scale=iw:ih", 
        "-af", filter,
        "output.mp4"
      );

      const data = ffmpeg.FS("readFile", "output.mp4");
      processedBlob = new Blob([data.buffer], { type: "video/mp4" });
      const url = URL.createObjectURL(processedBlob);

      const player = document.getElementById("videoPlayer");
      player.src = url;

      document.getElementById("downloadBtn").disabled = false;
    });

    document.getElementById("downloadBtn").addEventListener("click", () => {
      if (processedBlob) {
        const a = document.createElement("a");
        a.href = URL.createObjectURL(processedBlob);
        a.download = "video_jadul.mp4";
        a.click();
      }
    });
  </script>
</body>
</html>
